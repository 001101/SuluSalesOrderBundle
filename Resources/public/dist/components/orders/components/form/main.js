define([],function(){"use strict";var a="#order-form",b={accountContactsUrl:"/admin/api/accounts/<%= id %>/contacts?flat=true",accountAddressesUrl:"/admin/api/accounts/<%= id %>/addresses",accountUrl:"/admin/api/accounts?searchFields=name&flat=true&fields=id,name",accountInputId:"#account-input",deliveryAddressInstanceName:"delivery-address",paymentAddressInstanceName:"invoice-address",contactSelectId:"#contact-select",itemTableId:"#order-items"},c=function(){this.sandbox.emit("sulu.header.set-toolbar",{template:"default"})},d=function(){this.sandbox.on("sulu.header.toolbar.delete",function(){this.sandbox.emit("sulu.salesorder.order.delete",this.options.data.id)},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".initialized",function(){this.dfdAutoCompleteInitialized.resolve()},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".selection-removed",l.bind(this)),this.sandbox.on("sulu.salesorder.order.saved",function(a){this.options.data=a,this.setHeaderBar(!0)},this),this.sandbox.on("sulu.header.toolbar.save",function(){this.submit()},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.salesorder.orders.list")},this),this.sandbox.on("husky.input.desired-delivery-date.initialized",function(){this.dfdDesiredDeliveryDate.resolve()},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".select",l.bind(this)),this.sandbox.on("sulu.editable-data-row.delivery-address.initialized",function(){this.dfdDeliveryAddressInitialized.resolve()}.bind(this)),this.sandbox.on("sulu.editable-data-row.invoice-address.initialized",function(){this.dfdInvoiceAddressInitialized.resolve()}.bind(this)),this.sandbox.on("sulu.editable-data-row.address-view.delivery-address.changed",function(a){this.options.data.deliveryAddress=a,g.call(this,this.options.data),m.call(this)}.bind(this)),this.sandbox.on("sulu.editable-data-row.address-view.invoice-address.changed",function(a){this.options.data.invoiceAddress=a,g.call(this,this.options.data),m.call(this)}.bind(this))},e=function(){var a=this.sandbox.translate("salesorder.order"),b=[{title:"navigation.sales"},{title:"salesorder.orders.title",event:"sulu.salesorder.orders.list"}];this.options.data&&this.options.data.number&&(a+=" #"+this.options.data.number,b.push({title:"#"+this.options.data.number})),this.sandbox.emit("sulu.header.set-title",a),this.sandbox.emit("sulu.header.set-breadcrumb",b)},f=function(b){var c=this.sandbox.form.create(a);c.initialized.then(function(){g.call(this,b,!0),h.call(this,b)}.bind(this))},g=function(b){this.sandbox.form.setData(a,b).then(function(){this.accountId=i.call(this)}.bind(this)).fail(function(a){this.sandbox.logger.error("An error occured when setting data!",a)}.bind(this))},h=function(c){this.sandbox.start(a),this.dfdDesiredDeliveryDate.resolve(),c.account&&c.account.id&&n.call(this,c.account.id,c),this.sandbox.start([{name:"auto-complete@husky",options:{el:b.accountInputId,remoteUrl:b.accountUrl,resultKey:"accounts",getParameter:"search",value:c.account?c.account:"",instanceName:this.accountInstanceName,valueKey:"name",noNewValues:!0}}])},i=function(){return this.sandbox.dom.attr(b.accountInputId,"data-id")},j=function(a,b){b=b||[],this.sandbox.emit("husky.select.contact-select.update",a,b)},k=function(a,b,c){this.sandbox.emit("sulu.editable-data-row."+b+".data.update",a,c)},l=function(a){var c=a.id||null;c!==this.accountId&&(this.accountId=c,c?n.call(this,c):(j.call(this,[]),k.call(this,[],b.deliveryAddressInstanceName),k.call(this,[],b.paymentAddressInstanceName)))},m=function(){this.setHeaderBar(!1)},n=function(a,c){var d,e;this.sandbox.util.load(this.sandbox.util.template(b.accountContactsUrl,{id:a})).then(function(a){d=a._embedded.contacts,e=c&&c.contact?[c.contact.id]:null,j.call(this,d,e)}.bind(this)).fail(function(a,b){this.sandbox.logger.error(a,b)}.bind(this)),this.sandbox.util.load(this.sandbox.util.template(b.accountAddressesUrl,{id:a})).then(function(a){d=a._embedded.addresses,e=null,c&&c.deliveryAddress||(e=o.call(this,d,"deliveryAddress",!0)),this.sandbox.data.when(this.dfdDeliveryAddressInitialized).then(function(){k.call(this,d,b.deliveryAddressInstanceName,e),this.options.data.deliveryAddress=e,g.call(this,this.options.data)}.bind(this)),e=null,c&&c.invoiceAddress||(e=o.call(this,d,"billingAddress",!0)),this.sandbox.data.when(this.dfdInvoiceAddressInitialized).then(function(){k.call(this,d,b.paymentAddressInstanceName,e),this.options.data.invoiceAddress=e,g.call(this,this.options.data)}.bind(this))}.bind(this)).fail(function(a,b){this.sandbox.logger.error(a,b)}.bind(this))},o=function(a,b,c){var d=null;return a&&a.length>0&&this.sandbox.util.each(a,function(a,e){return e.hasOwnProperty(b)&&e[b]===c?(d=e,!1):void 0}.bind(this)),d};return function(){return{view:!0,layout:{},templates:["/admin/order/template/order/form"],initialize:function(){this.saved=!0,this.formId=a,this.accountId=null,this.contactId=null,this.dfdAllFieldsInitialized=this.sandbox.data.deferred(),this.dfdAutoCompleteInitialized=this.sandbox.data.deferred(),this.dfdDesiredDeliveryDate=this.sandbox.data.deferred(),this.dfdInvoiceAddressInitialized=this.sandbox.data.deferred(),this.dfdDeliveryAddressInitialized=this.sandbox.data.deferred(),this.sandbox.data.when(this.dfdDesiredDeliveryDate,this.dfdAutoCompleteInitialized).then(function(){this.dfdAllFieldsInitialized.resolve()}.bind(this)),e.call(this),this.render(),c.call(this),this.listenForChange(),this.setHeaderBar(!0),d.call(this)},initSidebar:function(a,b){this.sandbox.emit("sulu.sidebar.set-widget",a+b)},render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate(this.templates[0]));var a=this.options.data,b=a.id?a.id:"new";this.accountInstanceName="customerAccount"+b,f.call(this,a)},submit:function(){if(this.sandbox.logger.log("save Model"),this.sandbox.form.validate(a)){var b=this.sandbox.form.getData(a);""===b.id&&delete b.id,b.account={id:this.sandbox.dom.attr("#"+this.accountInstanceName,"data-id")},this.sandbox.logger.log("log data",b),this.sandbox.emit("sulu.salesorder.order.save",b)}},setHeaderBar:function(a){if(a!==this.saved){var b=this.options.data&&this.options.data.id?"edit":"add";this.sandbox.emit("sulu.header.toolbar.state.change",b,a,!0)}this.saved=a},listenForChange:function(){this.sandbox.data.when(this.dfdAllFieldsInitialized).then(function(){this.sandbox.dom.on(a,"change",m.bind(this),".changeListener select, .changeListener input, .changeListener .husky-select, .changeListener textarea"),this.sandbox.dom.on(a,"keyup",m.bind(this),".changeListener select, .changeListener input, .changeListener textarea"),this.sandbox.on("sulu.item-table.changed",m.bind(this))}.bind(this))}}}()});