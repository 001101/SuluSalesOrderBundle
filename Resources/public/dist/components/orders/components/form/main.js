define(["sulusalesorder/util/orderStatus","sulusalescore/util/helper","sulucontact/model/account"],function(a,b,c){"use strict";var d="#order-form",e={accountContactsUrl:"/admin/api/accounts/<%= id %>/contacts?flat=true",accountAddressesUrl:"/admin/api/accounts/<%= id %>/addresses",accountUrl:"/admin/api/accounts?searchFields=name&flat=true&fields=id,name",accountInputId:"#account-input",deliveryAddressInstanceName:"delivery-address",billingAddressInstanceName:"billing-address",paymentTermsInstanceName:"payment-terms",deliveryTermsInstanceName:"delivery-terms",contactSelectId:"#contact-select",validateWarningTranslation:"form.validation-warning",translationConversionFailed:"salescore.conversion-failed",translationShippingFailed:"salescore.shipping-failed"},f=function(){var b=[{id:"save-button",icon:"floppy-o",iconSize:"large","class":"highlight",position:1,group:"left",disabled:!0,callback:function(){this.sandbox.emit("sulu.header.toolbar.save")}.bind(this)}],c={icon:"gear",iconSize:"large",group:"left",id:"options-button",position:30,items:[{title:this.sandbox.translate("toolbar.delete"),callback:function(){this.sandbox.emit("sulu.header.toolbar.delete")}.bind(this)}]},d={icon:"hand-o-right",iconSize:"large",group:"left",id:"workflow",position:40,items:[]},e={confirm:{title:this.sandbox.translate("salesorder.orders.confirm"),callback:g.bind(this)},edit:{title:this.sandbox.translate("salesorder.orders.edit"),callback:h.bind(this)},shipping:{title:this.sandbox.translate("salesorder.orders.shipping.create"),callback:i.bind(this)},divider:{divider:!0}};this.options.data.id&&(this.orderStatusId===a.CREATED?d.items.push(e.confirm):this.orderStatusId===a.CONFIRMED&&d.items.push(e.edit),this.orderStatusId>=a.CONFIRMED&&(d.items.push(e.divider),d.items.push(e.shipping)),c.items.length>0&&b.push(c),d.items.length>0&&b.push(d)),this.sandbox.emit("sulu.header.set-toolbar",{template:b})},g=function(){k.call(this,function(){this.sandbox.emit("sulu.salesorder.order.confirm")},j.bind(this,e.translationConversionFailed))},h=function(){k.call(this,function(){this.sandbox.emit("sulu.salesorder.order.edit")},j.bind(this,e.translationConversionFailed))},i=function(){k.call(this,function(){this.sandbox.emit("sulu.salesorder.shipping.create")},j.bind(this,e.translationShippingFailed))},j=function(a){this.sandbox.emit("sulu.labels.error.show",this.sandbox.translate(a))},k=function(a,b){"function"==typeof a&&(this.saved?a.call(this):this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","sulu.overlay.save-unsaved-changes-confirm",null,function(){this.submit().then(a.bind(this),b.bind(this))}.bind(this)))},l=function(){return this.options.data&&this.options.data.status?this.options.data.status.id:null},m=function(a){this.options.orderStatuses=a},n=function(){this.sandbox.on("sulu.salesorder.set-order-status",m.bind(this)),this.sandbox.on("sulu.header.toolbar.delete",function(){this.sandbox.emit("sulu.salesorder.order.delete",this.options.data.id)},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".initialized",function(){this.isEditable||this.sandbox.dom.attr(this.$find(e.accountInputId+" input"),"disabled","disabled"),this.dfdAutoCompleteInitialized.resolve()},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".selection-removed",w.bind(this)),this.sandbox.on("sulu.salesorder.order.saved",function(a){this.options.data=a,o.call(this,!0),this.dfdFormSaved.resolve()},this),this.sandbox.on("sulu.header.toolbar.save",function(){this.submit()},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.salesorder.orders.list")},this),this.sandbox.on("husky.input.shipping-date.initialized",function(){this.dfdShippingDate.resolve()},this),this.sandbox.on("husky.input.order-date.initialized",function(){this.dfdOrderDate.resolve()},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".select",w.bind(this)),this.sandbox.on("sulu.editable-data-row."+e.deliveryAddressInstanceName+".initialized",function(){this.dfdDeliveryAddressInitialized.resolve()}.bind(this)),this.sandbox.on("sulu.editable-data-row."+e.billingAddressInstanceName+".initialized",function(){this.dfdInvoiceAddressInitialized.resolve()}.bind(this)),this.sandbox.on("sulu.editable-data-row.address-view."+e.deliveryAddressInstanceName+".changed",function(a){this.options.data.deliveryAddress=a,q.call(this,this.options.data),x.call(this)}.bind(this)),this.sandbox.on("sulu.editable-data-row.address-view."+e.billingAddressInstanceName+".changed",function(a){this.options.data.invoiceAddress=a,q.call(this,this.options.data),x.call(this)}.bind(this))},o=function(a){if(a!==this.saved){var b=this.options.data&&this.options.data.id?"edit":"add";this.sandbox.emit("sulu.header.toolbar.state.change",b,a,!0)}this.saved=a},p=function(a){var b=this.sandbox.form.create(d);b.initialized.then(function(){q.call(this,a,!0),r.call(this,a)}.bind(this))},q=function(a){this.sandbox.form.setData(d,a).then(function(){this.accountId=s.call(this)}.bind(this)).fail(function(a){this.sandbox.logger.error("An error occured when setting data!",a)}.bind(this))},r=function(a){this.sandbox.start(d),a.account&&a.account.id&&y.call(this,a.account.id,a),this.sandbox.start([{name:"auto-complete@husky",options:{el:e.accountInputId,remoteUrl:e.accountUrl,resultKey:"accounts",getParameter:"search",value:a.account?a.account:"",instanceName:this.accountInstanceName,valueKey:"name",noNewValues:!0}}])},s=function(){return this.sandbox.dom.attr(e.accountInputId,"data-id")},t=function(a,b){b=b||[],this.sandbox.emit("husky.select.contact-select.update",a,b)},u=function(a,b,c){this.sandbox.emit("sulu.editable-data-row."+b+".data.update",a,c)},v=function(a,b){this.sandbox.emit("sulu.editable-data-row."+a+".set-value",b)},w=function(a){var b=a.id||null;b!==this.accountId&&(this.accountId=b,b?y.call(this,b):(t.call(this,[]),u.call(this,[],e.deliveryAddressInstanceName),u.call(this,[],e.billingAddressInstanceName)))},x=function(){o.call(this,!1)},y=function(a,b){var d,f,g,h;g=c.findOrCreate({id:a}),g.fetch({success:function(a){g=a.toJSON();var c=null,d=null;b||(g.hasOwnProperty("termsOfDelivery")&&g.termsOfDelivery&&(d=g.termsOfDelivery.terms),v.call(this,e.deliveryTermsInstanceName,d),g.hasOwnProperty("termsOfPayment")&&g.termsOfPayment&&(c=g.termsOfPayment.terms),v.call(this,e.paymentTermsInstanceName,c)),g.hasOwnProperty("addresses")&&(h=g.addresses,f=null,b&&b.deliveryAddress?f=b.deliveryAddress:(f=z.call(this,h,"deliveryAddress",!0),!f&&h.length>0&&(f=h[0])),this.sandbox.data.when(this.dfdDeliveryAddressInitialized).then(function(){u.call(this,h,e.deliveryAddressInstanceName,f),this.options.data.deliveryAddress=f}.bind(this)),f=null,b&&b.invoiceAddress?f=b.invoiceAddress:(f=z.call(this,h,"billingAddress",!0),!f&&h.length>0&&(f=h[0])),this.sandbox.data.when(this.dfdInvoiceAddressInitialized).then(function(){u.call(this,h,e.billingAddressInstanceName,f),this.options.data.invoiceAddress=f}.bind(this)))}.bind(this),error:function(){this.sandbox.emit("sulu.labels.warning.show",this.sandbox.translate("error while fetching account"))}.bind(this)}),this.sandbox.util.load(this.sandbox.util.template(e.accountContactsUrl,{id:a})).then(function(a){d=a._embedded.contacts,f=b&&b.contact?[b.contact.id]:null,t.call(this,d,f)}.bind(this)).fail(function(a,b){this.sandbox.logger.error(a,b)}.bind(this))},z=function(a,b,c){var d=null;return a&&a.length>0&&this.sandbox.util.each(a,function(a,e){return e.hasOwnProperty(b)&&e[b]===c?(d=e,!1):void 0}.bind(this)),d};return{view:!0,layout:{sidebar:{width:"fixed",cssClasses:"sidebar-padding-50"}},templates:["/admin/order/template/order/form"],initialize:function(){this.saved=!0,this.formId=d,this.accountId=null,this.contactId=null,this.dfdFormSaved=this.sandbox.data.deferred(),this.dfdAllFieldsInitialized=this.sandbox.data.deferred(),this.dfdAutoCompleteInitialized=this.sandbox.data.deferred(),this.dfdShippingDate=this.sandbox.data.deferred(),this.dfdOrderDate=this.sandbox.data.deferred(),this.dfdInvoiceAddressInitialized=this.sandbox.data.deferred(),this.dfdDeliveryAddressInitialized=this.sandbox.data.deferred(),this.sandbox.data.when(this.dfdShippingDate,this.dfdOrderDate,this.dfdAutoCompleteInitialized).then(function(){this.dfdAllFieldsInitialized.resolve()}.bind(this)),this.orderStatusId=l.call(this),this.isEditable=this.orderStatusId<=a.IN_CART;var b=this.options.data.id?this.options.data.id:"new";this.accountInstanceName="customerAccount"+b,n.call(this),f.call(this),o.call(this,!0),this.render(),this.listenForChange(),this.options.data&&this.options.data.id&&this.initSidebar()},initSidebar:function(){var a,b,c="/admin/widget-groups/order-detail{?params*}",d=this.options.data;d.contact&&d.account&&d.status?(b=this.sandbox.uritemplate.parse(c),a=b.expand({params:{contact:d.contact.id,account:d.account.id,status:d.status.status,locale:SULU.user.locale,orderDate:d.orderDate,orderNumber:d.number,orderId:d.id}}),this.sandbox.emit("sulu.sidebar.set-widget",a)):this.sandbox.logger.error("required values for sidebar not present!")},render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate(this.templates[0],{isEditable:this.isEditable,parseDate:b.parseDate}));var a=this.options.data;p.call(this,a)},submit:function(){if(this.dfdFormSaved=this.sandbox.data.deferred(),this.sandbox.logger.log("save Model"),this.sandbox.form.validate(d)){var a=this.sandbox.form.getData(d);""===a.id&&delete a.id,a.account={id:this.sandbox.dom.attr("#"+this.accountInstanceName,"data-id")},this.sandbox.logger.log("log data",a),this.sandbox.emit("sulu.salesorder.order.save",a)}else this.sandbox.emit("sulu.labels.warning.show",this.sandbox.translate(e.validateWarningTranslation)),this.dfdFormSaved.reject();return this.dfdFormSaved},listenForChange:function(){this.sandbox.data.when(this.dfdAllFieldsInitialized).then(function(){this.sandbox.dom.on(d,"change",x.bind(this),".changeListener select, .changeListener input, .changeListener .husky-select, .changeListener textarea"),this.sandbox.dom.on(d,"keyup",x.bind(this),".changeListener select, .changeListener input, .changeListener textarea"),this.sandbox.on("sulu.item-table.changed",x.bind(this))}.bind(this))}}});