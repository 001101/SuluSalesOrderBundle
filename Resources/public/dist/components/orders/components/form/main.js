define([],function(){"use strict";var a="#order-form",b={accountContactsUrl:"/admin/api/accounts/<%= id %>/contacts?flat=true",accountAddressesUrl:"/admin/api/accounts/<%= id %>/addresses?flat=true",accountUrl:"/admin/api/accounts?searchFields=name&flat=true&fields=id,name",accountInputId:"#account-input",deliveryAddressInstanceName:"delivery-address-select",paymentAddressInstanceName:"payment-address-select",contactSelectId:"#contact-select",itemTableId:"#order-items"},c=function(){var a=[{id:"save-button",icon:"floppy-o",iconSize:"large","class":"highlight",position:1,group:"left",disabled:!0,callback:function(){this.sandbox.emit("sulu.header.toolbar.save")}.bind(this)}],b={icon:"gear",iconSize:"large",group:"left",id:"options-button",position:30,items:[{title:this.sandbox.translate("toolbar.delete"),callback:function(){this.sandbox.emit("sulu.header.toolbar.delete")}.bind(this)}]},c={icon:"hand-o-right",iconSize:"large",group:"left",id:"workflow",position:40,items:[]},g={confirm:{title:this.sandbox.translate("salesorder.order.confirm"),callback:d.bind(this)},edit:{title:this.sandbox.translate("salesorder.order.edit"),callback:e.bind(this)},shipping:{title:this.sandbox.translate("salesorder.order.shipping.create"),callback:f.bind(this)},divider:{divider:!0}};this.options.data.id&&(1===this.orderStatusId?c.items.push(g.confirm):3===this.orderStatusId&&c.items.push(g.edit),this.orderStatusId>2&&(c.items.push(g.divider),c.items.push(g.shipping)),b.items.length>0&&a.push(b),c.items.length>0&&a.push(c)),this.sandbox.emit("sulu.header.set-toolbar",{template:a})},d=function(){g.call(this,function(){this.sandbox.emit("sulu.salesorder.order.confirm")})},e=function(){g.call(this,function(){this.sandbox.emit("sulu.salesorder.order.edit")})},f=function(){g.call(this,function(){this.sandbox.emit("sulu.salesorder.shipping.create")})},g=function(a){"function"==typeof a&&(this.saved?a.call(this):this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","sulu.overlay.unsaved-changes-confirm",null,a.bind(this)))},h=function(){return this.options.data&&this.options.data.status?this.options.data.status.id:null},i=function(a){this.options.orderStatuses=a},j=function(){this.sandbox.on("sulu.salesorder.set-order-status",i.bind(this)),this.sandbox.on("sulu.header.toolbar.delete",function(){this.sandbox.emit("sulu.salesorder.order.delete",this.options.data.id)},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".initialized",function(){this.isEditable||this.sandbox.dom.attr(this.$find(b.accountInputId+" input"),"disabled","disabled"),this.dfdAutoCompleteInitialized.resolve()},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".selection-removed",s.bind(this)),this.sandbox.on("sulu.salesorder.order.saved",function(a){this.options.data=a,l.call(this,!0)},this),this.sandbox.on("sulu.header.toolbar.save",function(){this.submit()},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.salesorder.orders.list")},this),this.sandbox.on("husky.input.desired-delivery-date.initialized",function(){this.dfdDesiredDeliveryDate.resolve()},this),this.sandbox.on("husky.auto-complete."+this.accountInstanceName+".select",s.bind(this))},k=function(){var a=this.sandbox.translate("salesorder.order"),b=[{title:"navigation.sales"},{title:"salesorder.orders.title",event:"sulu.salesorder.orders.list"}];this.options.data&&this.options.data.number&&(a+=" #"+this.options.data.number,b.push({title:"#"+this.options.data.number})),this.sandbox.emit("sulu.header.set-title",a),this.sandbox.emit("sulu.header.set-breadcrumb",b)},l=function(a){if(a!==this.saved){var b=this.options.data&&this.options.data.id?"edit":"add";this.sandbox.emit("sulu.header.toolbar.state.change",b,a,!0)}this.saved=a},m=function(b){var c=this.sandbox.form.create(a);c.initialized.then(function(){n.call(this,b,!0),o.call(this,b)}.bind(this))},n=function(b){this.sandbox.form.setData(a,b).then(function(){this.accountId=p.call(this)}.bind(this)).fail(function(a){this.sandbox.logger.error("An error occured when setting data!",a)}.bind(this))},o=function(c){this.sandbox.start(a),this.dfdDesiredDeliveryDate.resolve(),c.account&&c.account.id&&u.call(this,c.account.id,c),this.sandbox.start([{name:"auto-complete@husky",options:{el:b.accountInputId,remoteUrl:b.accountUrl,resultKey:"accounts",getParameter:"search",value:c.account?c.account:"",instanceName:this.accountInstanceName,valueKey:"name",noNewValues:!0}}])},p=function(){return this.sandbox.dom.attr(b.accountInputId,"data-id")},q=function(a,b){b=b||[],this.sandbox.emit("husky.select.contact-select.update",a,b)},r=function(a,b,c){c=c||[],this.sandbox.emit("husky.select."+b+".update",a,c)},s=function(a){var c=a.id||null;c!==this.accountId&&(this.accountId=c,c?u.call(this,c):(q.call(this,[]),r.call(this,[],b.deliveryAddressInstanceName),r.call(this,[],b.paymentAddressInstanceName)))},t=function(){l.call(this,!1)},u=function(a,c){var d,e;this.sandbox.util.load(this.sandbox.util.template(b.accountContactsUrl,{id:a})).then(function(a){d=a._embedded.contacts,e=c&&c.contact?[c.contact.id]:null,q.call(this,d,e)}.bind(this)).fail(function(a,b){this.sandbox.logger.error(a,b)}.bind(this)),this.sandbox.util.load(this.sandbox.util.template(b.accountAddressesUrl,{id:a})).then(function(a){d=a._embedded.addresses,e=c&&c.deliveryAddress?[c.deliveryAddress.address]:null,r.call(this,d,b.deliveryAddressInstanceName,e),e=c&&c.invoiceAddress?[c.invoiceAddress.address]:null,r.call(this,d,b.paymentAddressInstanceName,e)}.bind(this)).fail(function(a,b){this.sandbox.logger.error(a,b)}.bind(this))};return{view:!0,layout:{},templates:["/admin/order/template/order/form"],initialize:function(){this.saved=!0,this.formId=a,this.accountId=null,this.contactId=null,this.dfdAllFieldsInitialized=this.sandbox.data.deferred(),this.dfdAutoCompleteInitialized=this.sandbox.data.deferred(),this.dfdDesiredDeliveryDate=this.sandbox.data.deferred(),this.sandbox.data.when(this.dfdDesiredDeliveryDate,this.dfdAutoCompleteInitialized).then(function(){this.dfdAllFieldsInitialized.resolve()}.bind(this)),this.orderStatusId=h.call(this),this.isEditable=!0,this.orderStatusId>2&&(this.isEditable=!1);var b=this.options.data.id?this.options.data.id:"new";this.accountInstanceName="customerAccount"+b,j.call(this),k.call(this),c.call(this),l.call(this,!0),this.render(),this.listenForChange()},initSidebar:function(a,b){this.sandbox.emit("sulu.sidebar.set-widget",a+b)},render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate(this.templates[0],{isEditable:this.isEditable}));var a=this.options.data;m.call(this,a)},submit:function(){if(this.sandbox.logger.log("save Model"),this.sandbox.form.validate(a)){var b=this.sandbox.form.getData(a);""===b.id&&delete b.id,b.account={id:this.sandbox.dom.attr("#"+this.accountInstanceName,"data-id")},this.sandbox.logger.log("log data",b),this.sandbox.emit("sulu.salesorder.order.save",b)}},listenForChange:function(){this.sandbox.data.when(this.dfdAllFieldsInitialized).then(function(){this.sandbox.dom.on(a,"change",t.bind(this),".changeListener select, .changeListener input, .changeListener .husky-select, .changeListener textarea"),this.sandbox.dom.on(a,"keyup",t.bind(this),".changeListener select, .changeListener input, .changeListener textarea"),this.sandbox.on("sulu.item-table.changed",t.bind(this))}.bind(this))}}});